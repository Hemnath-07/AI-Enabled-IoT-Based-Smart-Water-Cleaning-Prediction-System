# -*- coding: utf-8 -*-
"""backend.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1xcE3mIlyVhmFmgQRf83qjecqWAAkqq3L
"""

import pandas as pd
import numpy as np
import pickle
from sklearn.ensemble import RandomForestClassifier
from sklearn.preprocessing import LabelEncoder
from sklearn.model_selection import train_test_split

# Load dataset
df = pd.read_csv("/content/sample_data/water_potability.csv")

# Handle missing values
df.fillna(df.mean(), inplace=True)

# Add Month column (simulated for training)
df["Month"] = np.random.randint(1, 13, df.shape[0])

# Define cleaning level logic
def cleaning_level(row):
    if row["Turbidity"] > 5 or row["Solids"] > 1000:
        return "High"
    elif row["Turbidity"] > 3:
        return "Moderate"
    else:
        return "Low"

df["Cleaning_Level"] = df.apply(cleaning_level, axis=1)

# Features & Target
X = df[["Month", "ph", "Turbidity", "Solids", "Conductivity"]]
y = df["Cleaning_Level"]

# Encode labels
encoder = LabelEncoder()
y_encoded = encoder.fit_transform(y)

# Train-test split
X_train, X_test, y_train, y_test = train_test_split(
    X, y_encoded, test_size=0.2, random_state=42
)

# Train model
model = RandomForestClassifier(n_estimators=100, random_state=42)
model.fit(X_train, y_train)

# Save model & encoder
pickle.dump(model, open("cleaning_model.pkl", "wb"))
pickle.dump(encoder, open("label_encoder.pkl", "wb"))

print("âœ… Cleaning prediction model trained and saved")

from flask import Flask, request, jsonify
import pandas as pd
import pickle
from datetime import datetime

app = Flask(__name__)

model = pickle.load(open("/content/cleaning_model.pkl", "rb"))
encoder = pickle.load(open("/content/label_encoder.pkl", "rb"))

@app.route("/predict", methods=["POST"])
def predict():
    file = request.files["file"]
    df = pd.read_csv(file)

    df.fillna(df.mean(), inplace=True)

    current_month = datetime.now().month

    df["Month"] = current_month
    features = df[["Month", "ph", "Turbidity", "Solids", "Conductivity"]]
    avg_values = features.mean().values.reshape(1, -1)

    prediction = model.predict(avg_values)
    level = encoder.inverse_transform(prediction)[0]

    return jsonify({
        "month": datetime.now().strftime("%B"),
        "cleaning_level": level
    })

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=10000)

